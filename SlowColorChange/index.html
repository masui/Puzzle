<!--
  色がゆっくり変化することに気付けるかの実験

  2024/9/6 増井俊之
-->
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Change Blindness実験</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
  </head>
  <body>
    <h1>Change Blindness</h1>
    <ul>
      <li>ゆっくり変化するものに気付きにくいという性質の実験です</li>
      <li>ひとつの正方形の色がゆっくり変化するのに気付くでしょうか?</li>
      <li>10秒後、変化前の色と変化後の色が交互に表示されます</li>
    </ul>
    <div id="div" style="position:relative;"></div>
    <script type="text/javascript">
      const hex2 = (val) => `0${val.toString(16)}`.slice(-2)
      const colorstr = (r,g,b) => `#${hex2(r)}${hex2(g)}${hex2(b)}`
      const random = (n) => Math.floor(Math.random()*n)

      const SIZE = 5
      const changex = random(SIZE) // 変化する矩形の位置
      const changey = random(SIZE)
      
      for(let x=0;x<SIZE;x++){
          for(let y=0;y<SIZE;y++){
              $('<div>')
                  .css('position','absolute')
                  .css('width','100').css('height','100')
                  .css('top',y*100+20).css('left',x*100+20)
                  .css('background-color',
                       colorstr(random(256),random(256),random(256)))
                  .attr('id',`rect${x}${y}`)
		  .appendTo($('#div'))
		  //.appendTo($('body'))
          }
      }
      
      let startr = random(256) // 変化前の色
      let startg = random(256)
      let startb = random(256)
      let endr, endg, endb     // 変化後の色
      
      // 変化後の色を決める
      // 変化前の色とかなり違う色を選ぶ
      while(true){
          endr = random(256)
          endg = random(256)
          endb = random(256)
          if(Math.abs(endr-startr) > 80 &&
             Math.abs(endg-startg) > 80 &&
             Math.abs(endb-startb) > 80){
              break
          }
      }
      
      let rect = $(`#rect${changex}${changey}`) // 色が変化する矩形

      const sleep = (msTime) => new Promise(resolve => setTimeout(resolve, msTime)) // 無理矢理sleep()実装

      // alert(`${changex},${changey}`)

      const STEPS = 100
      async function loop() {
          while(true){
	      // 徐々に色を変更
              for(var i=0;i<STEPS;i++){
                  let r = Math.floor((startr * (STEPS-i) + endr * i) / STEPS)
                  let g = Math.floor((startg * (STEPS-i) + endg * i) / STEPS)
                  let b = Math.floor((startb * (STEPS-i) + endb * i) / STEPS)
                  rect.css('background-color',colorstr(r,g,b))
                  await sleep(100)
              }
              // 最初の色と最後の色を交互に表示
	      for(var i=0;i<3;i++){
                  rect.css('background-color',colorstr(startr,startg,startb))
                  await sleep(600)
                  rect.css('background-color',colorstr(endr,endg,endb))
                  await sleep(600)
              }
          }
      }

      loop()

    </script>	
  </body>
</html>
